Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2020-01-22T08:55:58+03:00

====== Davfs и WebDAV ======
Создан Среда 22 Январь 2020

===== Оглавление =====
1. Предисловие
2. Установка davfs
3. Монтирование раздела
4. Монтирование davfs пользователем

===== 1. Предисловие =====
Davfs это драйвер файловой системы, который позволяет монтировать сервер Web Distributed Authoring and Versioning (WebDAV) как диск.
WebDAV является дополнением к HTTP 1.1 который позволяет удалённо использовать веб-ресурсы. В частности, сервис Яндекс.Диск поддерживает работу с помощью WebDAV.

===== 2. Установка davfs =====
Репозиторий slackbuilds.org предоставляет SlackBuild для сборки пакета davfs2.
В файлах README и MINI_HOWTO содержится важная информация по сборке и использованию davfs2.
Перед сборкой davfs2 следует создать группу и пользователя davfs2:
{{{code: lang="sh" linenumbers="False"
$ groupadd -g 230 davfs2
$ useradd -u 230 -d /var/cache/davfs2 -g davfs2 davfs2
}}}


===== 3. Монтирование раздела =====
После установки davfs2, root может смонтировать WebDAV:
{{{code: lang="sh" linenumbers="False"
$ mount -t davfs https://webdav.example.com /mount/point
}}}


===== 4. Монтирование davfs пользователем =====
В качестве примера подключим webdav.yandex.ru. 

Создание каталога для монтирования сервера
{{{code: lang="sh" linenumbers="False"
$ mkdir ~/webdav
}}}

Добавьте пользователя в группу davfs2:
{{{code: lang="sh" linenumbers="False"
$ usermod -a -G davfs2 vasilij
$ groups vasilij
}}}

''vasilij : users floppy audio video cdrom plugdev power netdev vboxusers davfs2''

Добавьте запись WebDAV в [[/etc/fstab]]
{{{code: lang="sh" linenumbers="False"
$ sudo echo https://webdav.yandex.ru /home/user_name/webdav davfs user,noauto,uid=vasilij,file_mode=600,dir_mode=700 0 0 >> /etc/fstab
}}}


Монтирование/размонтирование ресурса
{{{code: lang="sh" linenumbers="False"
$ mount ~/webdav
$ umount ~/webdav
}}}

С небольшими файлами и быстрым соединением работает вполне прилично.
Если требуется просто скачать или закачать файл, можно обойтись программой cadaver:
{{{code: lang="sh" linenumbers="False"
$ cadaver https://webdav.yandex.ru
}}}


===== Настройка учетных данных =====
Для того, что бы не было необходимости вводить пароль при каждом монтировании, следует сообщить имя пользователя удаленного облачного диска и его пароль утилите «davfs2». Для этого необходимо редактировать файл /etc/davfs2/secrets или $HOME/.davfs2/secrets. Эти файлы содержат секретную информацию (пароль пользователя для доступа к удаленному облачному диску), следует позаботится о их сохранности и защищенности

Файл /etc/davfs2/secrets является системным, доступ на чтение к нему имеет только пользователь root, поэтому хранение пароля в нём более безопасно. Открыв этот файл для редактирования, необходимо ввести строку

$PathToMountPoint $USER $PASSWORD

с указанием абсолютного пути точки монтирования вместо $PathToMountPoint (так же как указано в файле «/etc/fstab»), имени пользователя у поставщика облачного диска вместо $USER и его пароля вместо $PASSWORD, например,

/mnt/cloud MyName 12345

Можно указывать адрес облачного диска, а не путь монтирования

$WebDAV_Address $USER $PASSWORD

, где параметр $WebDAV_Address аналогичен описанному в файле /etc/fstab, например,

https://example.com/webdav.php MyName 12345

Имеются проблемы с символами $^#& и пробелами в паролях. Следует использовать Escape-символы или окружать пароль скобками " ". Например пароль «qwe # rty» можно записать как
"qwe # rty"
или
qwe\ \#\ rty

Ввиду наличия секретной информации в этом файле, обязательно следует запретить другим пользователям системы производить его чтение, например, командой

$ chmod 600 $HOME/.davfs2/secrets

===== Настройка монтирования =====
Сопоставление адреса облачного диска и точки его монтирования производится за счет информации в файле /etc/fstab. В этот файл следует внести информацию о параметрах монтирования для каждого облачного диска.

Файл /etc/fstab следует дополнить строкой

$WebDAV_Address $PathToMountPoint davfs user,rw,noauto 0 0
или
$WebDAV_Address $PathToMountPoint davfs user,rw,_netdev 0 0

где «$WebDAV_Address» надо обязательно заменить на веб-адрес поставщика услуги сетевого облачного диска, а «$PathToMountPoint» обязательно заменить на абсолютный путь к точке монтирования (без переменных среды, начинающихся с символа «$», путь должен начинаться с символа «/»). Опция «noauto» указывает, что монтирование производится вручную, в то время как альтернативная ей опция _netdev – что монтирование будет произведено автоматически при наличии подключенного сетевого интерфейса.

Наличие опции noauto или _netdev обязательно, в противном случае считается, что указана опция auto и система будет пытаться подключить сетевой диск до поднятия самого сетевого интерфейса

Например, для распространенных поставщиков облачных дисков (и соответственно подобранного названия точки монтирования) эта строка в /etc/fstab может иметь вид
https://webdav.yandex.ru:443 /media/Yandex davfs user,rw,noauto 0 0

В этом примере явно указан порт для подключения. Это не обязательно, если поставщик облачного диска использует стандартные порты: 80 для HTTP и 443 для HTTPS.

===== Проверка монтирования =====
После завершения данных манипуляций целесообразно проверить монтирование, выполнив команду

mount $PathToMountPoint # где «$PathToMountPoint» точка монтирования облачного диска описанная в [[/etc/fstab]]
или
mount $WebDAV_Address # где $WebDAV_Address адрес для доступа к облачному диску, прописанный в /etc/fstab.

Отмонтировать такой диск можно командой
umount $PathToMountPoint
или
umount $WebDAV_Address

===== Автоматическое монтирование =====
Опция noauto не позволяет диску примонтироваться автоматически при старте системы. Для автоматического монтирования необходимо воспользоваться опцией _netdev, в таком случае попытка примонтировать диск будет произведена при загрузке системы, до входа под конкретным пользователем. Для этого, учетные данные доступа к облачному диску должны хранится в /etc/davfs2/secrets. Такой облачный сетевой диск будет монтироваться для всех пользователей ОС.

Если же диск должен монтироваться только для конкретного пользователя, то наряду с указанием опции noauto в /etc/fstab следует создать подобный скрипт

#!/bin/bash
sleep 120 && mount https://webdav.yandex.ru

и добавить его в автозагрузку этого пользователя.


